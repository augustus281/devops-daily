name: Generate DevOps Weekly Digest

on:
  workflow_dispatch:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Generate digest
        run: pnpm devops-daily:generate-news:no-ai

      - name: Get current week and year
        id: week
        run: |
          WEEK=$(date +%V)
          YEAR=$(date +%Y)
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "year=$YEAR" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'Add DevOps Weekly Digest - Week ${{ steps.week.outputs.week }}, ${{ steps.week.outputs.year }}'
          branch: devops-digest/week-${{ steps.week.outputs.week }}-${{ steps.week.outputs.year }}
          delete-branch: true
          title: 'DevOps Weekly Digest - Week ${{ steps.week.outputs.week }}, ${{ steps.week.outputs.year }}'
          body: |
            ## ðŸ“° DevOps Weekly Digest

            Automated weekly digest for **Week ${{ steps.week.outputs.week }}, ${{ steps.week.outputs.year }}**

            ### ðŸ¤– Generated Content

            This digest was automatically generated from 250+ DevOps sources using AI-powered classification and summarization.

            ### ðŸ“Š Stats

            - **Sources Monitored:** 250+
            - **Time Period:** Last 7 days
            - **Categories:** Kubernetes, Cloud Native, CI/CD, IaC, Security, Observability, and more

            ### âœ… Next Steps

            - Review the digest content
            - Approve and merge this PR to publish
            - The news will automatically appear on the website

            ---

            ðŸ”„ _This PR was automatically generated by the DevOps Daily Digest workflow_
          draft: false
          labels: |
            automated
            news
            digest
